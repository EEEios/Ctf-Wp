# 走进gun神 走进网安

参考链接：

https://blog.csdn.net/u011580175/article/details/83998946

https://www.jianshu.com/p/4c1e5d24d781

https://blog.csdn.net/csu_vc/article/details/79619309

![](http://doze9097.top//TIM图片20190827135959.jpg)

对于加密，是Web网安狗难以绕开的一个模块。

本篇文章主要讲解CBC加密模式以及CBC反转攻击。

要理解CBC字节反转攻击，首先当然是要理解CBC加密模式。

## CBC加密模式

CBC，全程Cipher-block chaining，中文为**密码分组链接**。是一种分组加密的加密模式。

> 对于**分组密码**，首先需要将明文按照指定长度进行分组（分组也可以成为块[block]），因此对于非指定倍数长度的明文，会导致最后一分组长度不能达到指定长度的要求，此时，可以选择**填充模式**来进行填充。
>
> 常见的填充模式可见链接：https://www.jianshu.com/p/16e1cbc0b7a9

### 加密准备

CBC加密需要准备：

1. Plaintext（明文）：带加密的文本。
2. Initialization Vector（初始向量）：即初始密钥，参与第一次异或，使得相同的明文仍能的到不同的密文。
3. key（加密密钥）。

4. Block Cipher Encryption（块/分组加密方法）：使用密钥加密处理过的明文。



<center><strong>注意：在下面的解析中，除了<u>第一组的IV</u>，其他组的其实都不叫做IV，仅是作为便于讲解</strong></center>
### 加密流程

![](http://doze9097.top//1566874258547.png)

> 1. 由于前一块密文要加入到后面分组的加密流程中，所以当明文中的一个字符改变时，将会影响到接下来的所有加密，使得密文与字符未改变的密文远不相同。
> 2. 每一份组的**明文**都需要等待该分组的**IV**（即前一组的密文，除第一组）进行异或才能得到**加密方法**的输入，所以加密过程不能并行处理。
> 3. 该加密模式中，重复的明文不会再密文中得到体现。

1. 将第一**分组**与**初始向量（IV）**异或。
2. 使用**密钥**及**加密方法**对明文进行加密得到第一组密文。
3. 保留第一组密文，并将第一组密文作为第二组的**IV**。
4. 对剩下的每一组都重复1~3步，获取每一组的密文。直至每一分组加密成功
5. 将**IV**和所有分组的密文拼接起来的到**最终密文**

### 解密流程

CBC解密准备：

1. Ciphertext（带解密的密文）
2. key（密钥）
3. IV（初始向量）：从密文中提取
4. block cipher decryption（块/分组解密方法）



<center><strong>注意：在下面的解析中，除了<u>第一组的IV</u>，其他组的其实都不叫做IV，仅是作为便于讲解</strong></center>
### 解密流程

![](http://doze9097.top//1566874115434.png)

>1. **解密方法**可以直接获得输入（即分好组的密文），该过程可以并行处理
>2. 密文中的一个字符被修改后，受影响的有改组明文和下一组明文的对应位置的字符

1. 第一组的密文作为第二组的**IV**，并用**密钥**对第一组**密文**进行解密。

2. 用该分组的**IV**与解密后的文本进行异或得到**明文**。

   > 异或（记为符号 ^）性质：A^B=C，则C^A=B，C^B=A；

3. 对每一组重复1~2得到每一组的明文。

4. 拼接得到的分组明文得到最终的明文。



## CBC反转攻击

CBC反转攻击的目的是通过密文修改明文，因为修改后的密文会影响到该分组明文和下一组明文的对应位置字符。为了改变明文字符，需要改变前一分组的密文字符。如下图：

![](http://doze9097.top//1566886207161.png)

> 注意：在改变密文字符后，密文组的明文会收到影响，但可以修改iv进行修复（若iv可控）

### 攻击准备

需知密文、分组方式（即每组长度）、目标位置明文。

### 攻击原理

异或（记为符号 ^）性质：A^B=C，则C^A=B，C^B=A；且有C^B^A=0。

这里，我们记

- A  - 前一组对应位置的密文字符（即上图Flipped ciphertext bits的红色块）
- B  - 该组对应位置的密文字符解密后的字符（还未到异或步骤）
- C  - 该组被改变的明文字符（改变之前的字符）
- A&#39;  - 前一组对应位置，改变后的密文字符（攻击者改变后的密文字符）
- C&#39;  - 该组改变后目标的明文字符 （因 A&#39; 改变后的字符，即上图Flipped plaintext bits的红色块）

有下列关系：

1. 解密过程中有 A ^ B=C ; (注意，B不能被改变)
2. 所以有 A ^ B ^ C = 0 ;
3. 所以有 A ^ B ^ C ^ C&#39; = C&#39; ; 
4. 对照2，3中的式子，能被攻击者操纵改变的只有A可知 A&#39; = A ^ C ^ C&#39; ;

利用该公式，使得我们即可以操纵明文中的字符



## 实验吧：简单的登录题

知识点：

union select 1,2	等价于	union select * from (select 1)a join (select 2)b

%00 截断





例子可以参考：http://www.vuln.cn/6109